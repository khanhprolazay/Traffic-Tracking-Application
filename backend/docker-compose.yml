version: "3"
services:
  influxdb:
    image: influxdb:latest
    container_name: influxdb
    ports:
      - "8086:8086"
    networks:
      - backend
    volumes:
      - ./volumes/influxdb:/var/lib/influxdb2:rw
    env_file:
      - ./env/influxdb.env

  zookeeper:
    container_name: zookeeper
    image: confluentinc/cp-zookeeper:latest
    networks:
      - backend
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - 22181:2181
    # volumes:
    #   - ./volumes/zookeeper/data:/var/lib/zookeeper/data
    #   - ./volumes/zookeeper/log:/var/lib/zookeeper/log

  kafka:
    container_name: kafka
    hostname: kafka
    image: confluentinc/cp-kafka:latest
    networks:
      - backend
    depends_on:
      - zookeeper
    ports:
      - 29092:29092
    # volumes:
    #   - ./volumes/kafka:/var/lib/kafka/data
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: EXTERNAL_SAME_HOST://:29092, INTERNAL://:9092
      KAFKA_ADVERTISED_LISTENERS: EXTERNAL_SAME_HOST://localhost:29092, INTERNAL://kafka:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT, EXTERNAL_SAME_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_DELETE_TOPIC_ENABLE: true

    healthcheck:
      test:
        ["CMD", "kafka-topics", "--bootstrap-server", "kafka:9092", "--list"]
      interval: 5s
      timeout: 10s
      retries: 20

  kafka_ui:
    container_name: kafka-ui
    image: provectuslabs/kafka-ui:latest
    networks:
      - backend
    ports:
      - 8080:8080
    depends_on:
      - kafka
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092

  telegraf:
    image: telegraf:latest
    container_name: telegraf
    depends_on:
      - influxdb
      - zookeeper
    networks:
      - backend
    volumes:
      # Mount for telegraf config
      - ./config/telegraf.conf:/etc/telegraf/telegraf.conf:ro
    env_file:
      - ./env/influxdb.env


  # chronograf:
  #   image: chronograf:latest
  #   ports:
  #     - "8888:8888"
  #   volumes:
  #     - ./volumes/chronograf:/var/lib/chronograf
  #   depends_on:
  #     - influxdb
  #   environment:
  #     - INFLUXDB_URL=http://influxdb:8086
  #     - INFLUXDB_USERNAME=admin@gmail.com
  #     - INFLUXDB_PASSWORD=7cb4df40-5339-45b9-a812-4cc84ece400c
  #     - TOKEN_SECRET=2d6ca67a-f528-46ad-b548-0750d1379ed7
  #     - USE_V2_API=true
  #     - JWKS_URL=https://keycloak.bagiit.vn/realms/sap/protocol/openid-connect/certs
  #     - PUBLIC_URL=http://localhost:8888
  #     - GENERIC_CLIENT_ID=chronograf
  #     - GENERIC_CLIENT_SECRET=0JMTZhvx6mpBRPokClTxWwtTS6paX4DH
  #     - GENERIC_AUTH_URL=https://keycloak.bagiit.vn/realms/sap/protocol/openid-connect/auth
  #     - GENERIC_TOKEN_URL=https://keycloak.bagiit.vn/realms/sap/protocol/openid-connect/token
  #     - GENERIC_SCOPES=openid,profile,email
  #     - GENERIC_API_URL=https://keycloak.bagiit.vn/realms/sap/protocol/openid-connect/userinfo
  #     - "CUSTOM_LINKS=Keycloak Logout:https://keycloak.bagiit.vn/realms/sap/protocol/openid-connect/logout"
  # jobmanager:
  #   image: flink:latest
  #   ports:
  #     - "8081:8081"
  #   command: jobmanager
  #   environment:
  #     - JOB_MANAGER_RPC_ADDRESS=jobmanager

  # taskmanager:
  #   image: flink:latest
  #   depends_on:
  #     - jobmanager
  #   command: taskmanager
  #   environment:
  #     - JOB_MANAGER_RPC_ADDRESS=jobmanager

networks:
  backend:
    driver: bridge
    name: traffic-monitoring
